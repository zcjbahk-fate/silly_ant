# yaml-language-server: $schema=https://testingcf.jsdelivr.net/gh/StageDog/tavern_sync/dist/schema/character.zh.json
头像: 头像
版本: '1.7'
作者: 美羽
备注: 本卡免费发布，支持二创，禁止转载至付费酒馆。

第一条消息:
  - 文件: 第一条消息\0

角色描述: 这是一个友好的村民帮助女明星接受故乡独特传统习俗的故事。

锚点: {}

世界书名称: 陈蛮村男性视角
条目:
  - 名称: ===变量开始===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: '[initvar]变量初始化勿开'
    启用: false
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: true
      不可激活其他条目: true
    文件: 世界书\变量\[initvar]变量初始化勿开

  - 名称: 变量列表
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 指定深度
      角色: 系统
      深度: 0
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: true
      不可激活其他条目: true
    文件: 世界书\变量\变量列表

  - 名称: '[mvu_update]变量更新规则'
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 指定深度
      角色: 系统
      深度: 0
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: true
      不可激活其他条目: true
    文件: 世界书\变量\[mvu_update]变量更新规则

  - 名称: '[mvu_update]变量输出格式'
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 指定深度
      角色: 系统
      深度: 0
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: true
      不可激活其他条目: true
    文件: 世界书\变量\[mvu_update]变量输出格式

  - 名称: ===变量结束===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: ===阶段开始===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: '[通用]好感度阶段'
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\阶段\[通用]好感度阶段

  - 名称: '[通用]堕落度阶段'
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\阶段\[通用]堕落度阶段

  - 名称: '[通用]性欲值阶段'
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\阶段\[通用]性欲值阶段

  - 名称: '[通用]NTR阶段'
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\阶段\[通用]NTR阶段

  - 名称: 陈倩_数值系统入口
    启用: true
    激活策略:
      类型: 绿灯
      关键字:
        - 陈倩
    插入位置:
      类型: 指定深度
      角色: 系统
      深度: 0
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: true
      不可激活其他条目: true
    文件: 世界书\阶段\陈倩_数值系统入口

  - 名称: 侯琳琳_数值系统入口
    启用: true
    激活策略:
      类型: 绿灯
      关键字:
        - 侯琳琳
    插入位置:
      类型: 指定深度
      角色: 系统
      深度: 0
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: true
      不可激活其他条目: true
    文件: 世界书\阶段\侯琳琳_数值系统入口

  - 名称: 江雪晴_数值系统入口
    启用: true
    激活策略:
      类型: 绿灯
      关键字:
        - 江雪晴
    插入位置:
      类型: 指定深度
      角色: 系统
      深度: 0
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: true
      不可激活其他条目: true
    文件: 世界书\阶段\江雪晴_数值系统入口

  - 名称: ===阶段结束===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: ===主要角色开始===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: 陈琛宝
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\主要角色\陈琛宝

  - 名称: 陈倩
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\主要角色\陈倩

  - 名称: ===主要角色结束===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: ===次要角色开始===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: NPC
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 作者注释之后
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\次要角色\NPC

  - 名称: 候琳琳
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之前
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\次要角色\候琳琳

  - 名称: 江雪晴
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之前
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\次要角色\江雪晴

  - 名称: ===次要角色结束===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: ===地点开始===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: 陈蛮村
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之前
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\地点\陈蛮村

  - 名称: 祠堂
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之后
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\地点\祠堂

  - 名称: ===地点结束===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: ===其他开始===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

  - 名称: 年猪
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\其他\年猪

  - 名称: 年货
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之后
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\其他\年货

  - 名称: 贡女
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之后
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\其他\贡女

  - 名称: 描写指导
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之后
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\其他\描写指导

  - 名称: 仪式汇演
    启用: true
    激活策略:
      类型: 蓝灯
    插入位置:
      类型: 角色定义之后
      顺序: 100
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    文件: 世界书\其他\仪式汇演

  - 名称: ===其他结束===
    启用: false
    激活策略:
      类型: 向量化
    插入位置:
      类型: 角色定义之前
      顺序: 14720
    激活概率: 100
    递归:
      不可被其他条目激活: false
      不可激活其他条目: false
    内容: ''

扩展字段:
  正则:
    - 正则名称: 状态栏
      id: 4aab3972-2f6c-429d-a9aa-ac894180004e
      启用: true
      查找表达式: <StatusPlaceHolderImpl/>
      文件: 正则\状态栏
      来源:
        用户输入: false
        AI输出: true
      作用于:
        仅格式显示: true
        仅格式提示词: false
      最大深度: 2

    - 正则名称: 只发送最新3楼的变量更新
      id: 1ed1ea7d-58e1-4bc9-88b3-1567804fd166
      启用: true
      查找表达式: /<UpdateVariable>[\s\S]*?</UpdateVariable>/gm
      内容: ''
      来源:
        用户输入: false
        AI输出: true
      作用于:
        仅格式显示: false
        仅格式提示词: true
      最小深度: 6

    - 正则名称: 仅格式思维链
      id: 808c650b-5706-49de-a335-d121a37c85fe
      启用: true
      查找表达式: /<Analysis>[\s\S]+?<\/Analysis>/gm
      内容: ''
      来源:
        用户输入: false
        AI输出: true
      作用于:
        仅格式显示: false
        仅格式提示词: true

    - 正则名称: 对 AI 隐藏状态栏
      id: 1bd9e78f-7653-422c-8fd5-b783d3f0a5d0
      启用: true
      查找表达式: <StatusPlaceHolderImpl/>
      内容: ''
      来源:
        用户输入: false
        AI输出: true
      作用于:
        仅格式显示: false
        仅格式提示词: true

    - 正则名称: '[美化]完整变量完成-夜空诗意'
      id: 87b7c1e8-f19b-4b10-a183-b8781c69b024
      启用: true
      查找表达式: /<UpdateVariable(?:variable)?>\s*(.*)\s*<\/UpdateVariable(?:variable)?>/gsi
      文件: 正则\[美化]完整变量完成-夜空诗意
      来源:
        用户输入: false
        AI输出: true
      作用于:
        仅格式显示: true
        仅格式提示词: false

    - 正则名称: '[美化]变量更新中-夜空诗意'
      id: 614f49d0-8136-4fce-9c04-06465ceab036
      启用: true
      查找表达式: /<UpdateVariable(?:variable)?>(?!.*<\/UpdateVariable(?:variable)?>)\s*(.*)\s*$/gsi
      文件: 正则\[美化]变量更新中-夜空诗意
      来源:
        用户输入: false
        AI输出: true
      作用于:
        仅格式显示: true
        仅格式提示词: false

  酒馆助手:
    脚本库:
      - 名称: 自动更新
        id: b0386104-2318-4afa-ad51-c10b6077d3a9
        启用: true
        类型: 脚本
        内容: import
          'https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/酒馆助手/自动更新角色卡/index.js'
        介绍: |
          # 自动更新角色卡

          - **作者:** 青空莉想做舞台少女的狗
          - **版本:** 2025/02/11
          - **源文件:** [点此跳转](https://github.com/StageDog/tavern_resource/tree/main/src)

          在角色卡面板中加载你要自动更新的角色卡, 将这个脚本添加到酒馆助手 "角色脚本" 中, 编辑脚本, 在`变量列表`中填入角色卡名称、角色卡链接和更新日志链接.

          例如:

          ```yaml
          {
            角色卡名称: 自动更新角色卡示例
            角色卡链接: https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/自动更新角色卡/示例角色卡.png
            更新日志链接: https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/自动更新角色卡/示例更新日志.md
          }
          ```

          其中,

          - 角色卡名称要和角色卡在酒馆中的名称一样, 确定好后不能再更改
          - 角色卡链接和更新日志链接必须是固定的, 而且访问的是最新版本角色卡和更新日志文件.

          比如, 你可以把角色卡和更新日志文件上传到 github, 然后使用 `https://testingcf.jsdelivr.net/gh/用户名/仓库名/文件路径` 作为角色卡链接和更新日志链接 (不清楚怎么做可以搜索一下或者问 AI).

          而更新日志应该按下面这样填写:

          ```md
          # 更新日志

          ## 这里填的会是角色卡版本号, 最上面一个版本是最新版本

          - 最新版本更新了啥……

          ## 新春版

          - 这个版本更新了啥……

          ## 1.0.0

          - 这个版本更新了啥……
          ```

          这样一来, 只要你更新链接所访问到的角色卡和更新日志, 玩家就能在酒馆中直接更新角色卡, 不需要去帖子查看更新, 不需要再下载、导入新角色卡了!

          另外, 你可以配合[实时编写角色卡、世界书或角色卡](https://stagedog.github.io/青空莉/工具经验/实时编写角色卡、世界书或角色卡/)来做到: 在 VSCode 中对角色卡进行一些修改, 上传到 github, 玩家在酒馆中自动收到更新.
        按钮:
          启用: true
          按钮列表:
            - 名称: '更新角色卡: 陈蛮村更新内容'
              可见: true
            - 名称: 更新日志
              可见: true
        数据:
          角色卡名称: 陈蛮村
          角色卡链接: https://raw.githubusercontent.com/zcjbahk-fate/silly_ant/refs/heads/main/resource/角色卡/陈蛮村/陈蛮村.png
          更新日志链接: https://raw.githubusercontent.com/zcjbahk-fate/silly_ant/refs/heads/main/resource/角色卡/陈蛮村/更新日志.md

      - 名称: mvu
        id: b0bfd78a-5233-45d3-93d1-cca237bc0ab7
        启用: true
        类型: 脚本
        内容: |
          import 'https://testingcf.jsdelivr.net/gh/MagicalAstrogy/MagVarUpdate/artifact/bundle.js';
        按钮:
          启用: true
          按钮列表:
            - 名称: 重新处理变量
              可见: false
            - 名称: 重新读取初始变量
              可见: false
            - 名称: 快照楼层
              可见: false
            - 名称: 重演楼层
              可见: false
            - 名称: 重试额外模型解析
              可见: false
            - 名称: 清除旧楼层变量
              可见: false

      - 名称: zod
        id: 70edd0c0-5425-49bf-b210-a095e8a29d7c
        启用: true
        类型: 脚本
        内容: |
          import { registerMvuSchema } from "https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/util/mvu_zod.js";

          // 1. 性经历通用逻辑（自动计算总数）
          const SexExpSchema = z
            .object({
              口交: z.coerce.number().int().prefault(0),
              足交: z.coerce.number().int().prefault(0),
              插入: z.coerce.number().int().prefault(0),
              肛交: z.coerce.number().int().prefault(0),
              手交: z.coerce.number().int().prefault(0),
            })
            .transform((data) => {
              // 强制修正负数
              data.口交 = Math.max(0, data.口交);
              data.足交 = Math.max(0, data.足交);
              data.插入 = Math.max(0, data.插入);
              data.肛交 = Math.max(0, data.肛交);
              data.手交 = Math.max(0, data.手交);
              const total = data.口交 + data.足交 + data.插入 + data.肛交 + data.手交;
              return { ...data, 总数: total };
            });

          // 2. 苦主的绿帽档案逻辑
          const NtrRecordSchema = z.object({
            NTR: z.coerce.number().prefault(0),
          }).transform(data => {
            data.NTR = _.clamp(data.NTR, 0, 100);
            return data;
          });

          // --- 主结构定义 ---
          export const Schema = z.object({
            系统: z.object({
              距离除夕还剩天数: z.coerce.number().prefault(7),
            }).transform(data => {
              data.距离除夕还剩天数 = _.clamp(data.距离除夕还剩天数, 0, 7);
              return data;
            }),

            // 主角变量
            主角: z.object({
              年龄: z.coerce.number().int().prefault(24),

              性器状态: z.object({
                肉棒: z.object({
                  当前长度: z.coerce.number().prefault(0),
                  状态: z.string().prefault("未勃起"),
                  描述: z.string().prefault("无"),
                }),
              }),

              // 主角的配种记录
              性经历: z.record(z.string().describe("女性角色名"), SexExpSchema).prefault({}),
            }),

            // NPC变量
            角色: z
              .record(
                z.string().describe("角色名"),
                z.object({
                  年龄: z.coerce.number().int().prefault(24),
                  是否知晓村中习俗: z.string().prefault("未知"),

                  // 这里只做基础定义，去掉单点的 transform
                  好感度: z.coerce.number().prefault(0),
                  堕落度: z.coerce.number().prefault(0),
                  性欲值: z.coerce.number().prefault(0),

                  NTR关系: z.object({
                    苦主姓名: z.string().prefault("无"),
                    出轨对象: z.record(z.string().describe("黄毛名字"), NtrRecordSchema).prefault({}),
                  }),

                  当前姿势: z.string().prefault("站立"),
                  内心想法: z.string().prefault("无"),
                  对主角看法: z.string().prefault("无"),

                  体内精液: z
                    .record(
                      z.string().describe("来源人名"),
                      z.object({
                        量: z.coerce.number().prefault(0),
                        状态: z.string().prefault("干净"),
                      })
                    )
                    .prefault({}),

                  上次做爱: z.object({
                    时间: z.string().prefault("无"),
                    对象: z.string().prefault("无"),
                    地点: z.string().prefault("无"),
                    方式: z.string().prefault("无"),
                  }),

                  性经历: z.record(z.string().describe("对象名"), SexExpSchema).prefault({}),
                })
                // 【重点】在这里对整个角色对象进行拦截修正
                .transform(data => {
                  data.好感度 = _.clamp(data.好感度, 0, 100);
                  data.堕落度 = _.clamp(data.堕落度, 0, 100);
                  data.性欲值 = _.clamp(data.性欲值, 0, 100);

                  // 顺便把精液量也做个负数拦截，以防万一
                  if (data.体内精液) {
                    Object.values(data.体内精液).forEach(semen => {
                      semen.量 = Math.max(0, semen.量);
                    });
                  }
                  return data;
                })
              )
              .prefault({}),
          });

          $(() => {
            registerMvuSchema(Schema);
          });

    变量: {}
